<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Voucher - Print</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../../../js/auth.js"></script>
    <style>
        @media print {
            body {
                margin: 0;
                font-size: 9px;
            }

            .no-print {
                display: none !important;
            }

            .print-page {
                page-break-after: always;
            }

            /* Prevent page breaks for single page documents */
            .voucher-container {
                page-break-inside: avoid;
                max-height: 100vh;
                padding: 5px !important;
            }

            /* Reduce margins and spacing for print */
            .header {
                margin-bottom: 5px !important;
            }

            .company-name {
                font-size: 14px !important;
                margin-bottom: 2px !important;
            }

            .company-address {
                font-size: 9px !important;
                line-height: 1.2 !important;
            }

            .payment-to {
                font-size: 10px !important;
                margin-top: 5px !important;
            }

            .voucher-details {
                font-size: 9px !important;
            }

            .voucher-title {
                margin: 5px 0 !important;
                font-size: 16px !important;
            }

            .document-info {
                margin-bottom: 5px !important;
                padding: 4px !important;
            }

            .document-info h3 {
                font-size: 11px !important;
                margin-bottom: 5px !important;
                padding-bottom: 2px !important;
            }

            .document-info .info-item {
                padding: 2px 0 !important;
            }

            .document-info strong {
                font-size: 9px !important;
                min-width: 100px !important;
            }

            .document-info span {
                font-size: 9px !important;
            }

            .approval-boxes {
                margin-bottom: 5px !important;
                gap: 5px !important;
            }

            .approval-box {
                padding: 3px !important;
                min-height: 30px !important;
            }

            .approval-title {
                font-size: 9px !important;
                margin-bottom: 5px !important;
            }

            .approval-stamp {
                height: 18px !important;
                margin-bottom: 3px !important;
            }

            .approval-stamp-text {
                font-size: 8px !important;
                padding: 1px 4px !important;
            }

            .amount-section {
                margin-bottom: 5px !important;
            }

            .amount-row {
                margin-bottom: 5px !important;
            }

            .amount-value {
                font-size: 12px !important;
            }

            .footer-note {
                margin-top: 5px !important;
                font-size: 8px !important;
            }
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .voucher-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        @media print {
            .voucher-container {
                padding: 5px !important;
                box-shadow: none !important;
                page-break-inside: avoid !important;
                max-height: none !important;
                overflow: visible !important;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        @media print {
            .header {
                margin-bottom: 10px;
            }
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .company-address {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .payment-to {
            margin-top: 10px;
            font-size: 14px;
        }

        .voucher-details {
            text-align: right;
            flex: 1;
        }

        .voucher-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            text-transform: uppercase;
        }

        @media print {
            .voucher-title {
                margin: 10px 0;
                font-size: 20px;
            }
        }

        .payment-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        @media print {
            .payment-table {
                margin-bottom: 8px !important;
                font-size: 8px !important;
                page-break-inside: avoid !important;
            }

            .payment-table th,
            .payment-table td {
                padding: 2px !important;
                font-size: 8px !important;
            }

            /* Ensure all text elements are smaller for print */
            * {
                font-size: 9px !important;
            }

            /* Specific font sizes for print */
            .company-name {
                font-size: 14px !important;
            }

            .voucher-title {
                font-size: 16px !important;
            }

            .amount-value {
                font-size: 12px !important;
            }

            .footer-note {
                font-size: 8px !important;
            }
        }

        .payment-table th,
        .payment-table td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            font-size: 11px;
        }

        @media print {

            .payment-table th,
            .payment-table td {
                padding: 4px;
                font-size: 9px;
            }
        }

        .payment-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .payment-table .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
        }

        .payment-table .amount {
            text-align: right;
        }

        /* Page break controls for payment table - Removed forced breaks */
        @media print {

            /* Ensure total row stays with last items */
            .payment-table .total-row {
                page-break-inside: avoid;
            }

            /* Prevent page breaks within payment table for small content */
            .payment-table {
                page-break-inside: avoid;
            }
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
        }

        .invoice-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .invoice-table .amount {
            text-align: right;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .supporting-docs {
            margin-bottom: 20px;
        }

        .doc-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .doc-item::after {
            content: '';
            flex: 1;
            border-bottom: 1px dotted #000;
            margin-left: 10px;
        }

        .approval-boxes {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        @media print {
            .approval-boxes {
                margin-bottom: 8px !important;
                gap: 5px !important;
                page-break-inside: avoid !important;
            }
        }

        .approval-box {
            flex: 1;
            min-width: 150px;
            border: 1px solid #000;
            padding: 10px;
            min-height: 60px;
            text-align: center;
        }

        @media print {
            .approval-box {
                padding: 6px;
                min-height: 45px;
            }
        }

        .approval-box {
            border: 1px solid #000;
            padding: 5px;
            min-height: 45px;
            text-align: center;
        }

        .approval-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .approval-signature {
            height: 30px;
            border-bottom: 1px solid #ccc;
        }

        /* Approval stamp styling */
        .approval-stamp {
            position: relative;
            width: 100%;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

        .approval-stamp-text {
            color: #0056b3;
            font-weight: bold;
            font-size: 10px;
            border: 2px solid #0056b3;
            border-radius: 4px;
            padding: 2px 6px;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .amount-section {
            margin-bottom: 20px;
        }

        @media print {
            .amount-section {
                margin-bottom: 8px !important;
                page-break-inside: avoid !important;
            }
        }

        .amount-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .amount-label {
            font-weight: bold;
        }

        .amount-value {
            font-weight: bold;
            font-size: 16px;
        }

        .footer-note {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 20px;
            font-style: italic;
        }

        @media print {
            .footer-note {
                margin-top: 10px;
                font-size: 10px;
            }

            /* Page numbering styles for print */
            .page-number {
                position: fixed;
                bottom: 10px;
                right: 20px;
                font-size: 10px;
                color: #666;
                font-weight: bold;
            }

            /* Hide page number on screen */
            .page-number {
                display: none;
            }

            /* Show page number only when printing */
            @media print {
                .page-number {
                    display: block !important;
                }
            }
        }

        /* Page numbering footer styles */
        .page-number-footer {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-size: 12px;
            color: #333;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .page-number-text {
            font-family: Arial, sans-serif;
        }

        .current-page {
            color: #007bff;
            font-weight: bold;
        }

        .total-pages {
            color: #28a745;
            font-weight: bold;
        }

        @media print {
            .page-number-footer {
                display: block !important;
                position: fixed !important;
                bottom: 10px !important;
                right: 15px !important;
                font-size: 10px !important;
                background-color: white !important;
                border: 1px solid #000 !important;
                box-shadow: none !important;
                padding: 3px 8px !important;
            }

            /* CSS counters for page numbering */
            @page {
                counter-increment: page;
            }

            .current-page::after {
                content: counter(page);
            }

            .total-pages::after {
                content: counter(pages);
            }
        }

        .no-print {
            margin-bottom: 20px;
        }

        .print-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .print-button:hover {
            background-color: #0056b3;
        }

        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .back-button:hover {
            background-color: #545b62;
        }

        .document-info {
            margin-bottom: 15px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        @media print {
            .document-info {
                margin-bottom: 8px !important;
                padding: 4px !important;
                background: white !important;
                border: 1px solid #000 !important;
                page-break-inside: avoid !important;
            }
        }

        .document-info h3 {
            font-weight: 700;
            margin-bottom: 10px;
            color: #1e293b;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 5px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .document-info .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .document-info .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .document-info .info-item:last-child {
            border-bottom: none;
        }

        .document-info strong {
            color: #374151;
            font-weight: 600;
            font-size: 12px;
            min-width: 120px;
        }

        .document-info span {
            color: #1f2937;
            font-weight: 500;
            text-align: right;
            flex: 1;
            font-size: 12px;
        }

        .approval-details {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .approval-details h3 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }

        .attachments-section {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        /* File Attachment Section styling */
        #fileAttachmentSection {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        #fileAttachmentSection h3 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            font-size: 14px;
        }

        #fileAttachmentList {
            min-height: 20px;
            padding: 4px;
        }

        /* List attachment styling */
        .attachment-list-item {
            display: flex;
            align-items: center;
            padding: 4px 6px;
            margin-bottom: 1px;
            border-radius: 3px;
            font-size: 11px;
            line-height: 1.3;
        }

        .attachment-list-item:last-child {
            margin-bottom: 0;
        }

        .attachment-list-item .file-icon {
            margin-right: 6px;
            font-size: 12px;
        }

        .attachment-list-item .file-name {
            font-weight: 500;
            color: #374151;
        }

        /* Blue theme for outgoing payment attachments */
        .attachment-list-item.blue-theme {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
        }

        .attachment-list-item.blue-theme .file-name {
            color: #1e40af;
        }

        /* Green theme for reimbursement attachments */
        .attachment-list-item.green-theme {
            background-color: #f0fdf4;
            border: 1px solid #86efac;
        }

        .attachment-list-item.green-theme .file-name {
            color: #047857;
        }

        /* Attachment styling for print page */
        .reimbursement-header {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .reimbursement-attachments-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .reimbursement-attachments-list .flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.25rem;
        }

        .reimbursement-attachments-list .space-x-2 {
            display: flex;
            gap: 0.5rem;
        }

        .reimbursement-attachments-list .text-lg {
            font-size: 1.125rem;
        }

        .reimbursement-attachments-list .text-sm {
            font-size: 0.875rem;
        }

        .reimbursement-attachments-list .text-xs {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .reimbursement-attachments-list .text-blue-600 {
            color: #2563eb;
        }

        .reimbursement-attachments-list .text-blue-800 {
            color: #1e40af;
        }

        .reimbursement-attachments-list .text-gray-500 {
            color: #6b7280;
        }

        .reimbursement-attachments-list .text-green-600 {
            color: #059669;
        }

        .reimbursement-attachments-list .hover\:text-blue-800:hover {
            color: #1e40af;
        }

        .reimbursement-attachments-list .hover\:text-green-800:hover {
            color: #047857;
        }

        .reimbursement-attachments-list .hover\:bg-blue-50:hover {
            background-color: #eff6ff;
        }

        .reimbursement-attachments-list .hover\:bg-green-50:hover {
            background-color: #f0fdf4;
        }

        .reimbursement-attachments-list .border-blue-300 {
            border-color: #93c5fd;
        }

        .reimbursement-attachments-list .border-green-300 {
            border-color: #86efac;
        }

        .reimbursement-attachments-list .rounded {
            border-radius: 0.25rem;
        }

        .reimbursement-attachments-list .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .reimbursement-attachments-list .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        /* Print Out Reimbursement Section styling */
        #printOutReimbursementSection {
            margin-bottom: 0.5rem;
        }

        #printOutReimbursementSection h4 {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        #printOutReimbursementList {
            min-height: 1rem;
        }

        .attachments-section h3 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 5px;
            font-size: 14px;
        }

        .reimbursement-attachments-section {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #28a745;
            background-color: #f8fff9;
            border-radius: 5px;
        }

        .reimbursement-attachments-section h3 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #28a745;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
            font-size: 14px;
        }

        @media print {
            .attachments-section {
                margin-bottom: 8px !important;
                padding: 8px !important;
                background-color: white !important;
                border: 1px solid #000 !important;
                page-break-inside: avoid !important;
            }

            #fileAttachmentSection {
                margin-bottom: 8px !important;
                padding: 8px !important;
                background-color: white !important;
                border: 1px solid #000 !important;
                page-break-inside: avoid !important;
            }

            #fileAttachmentSection h3 {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                padding-bottom: 3px !important;
            }

            #fileAttachmentList {
                padding: 2px !important;
                min-height: 10px !important;
            }

            .attachment-list-item {
                padding: 2px 4px !important;
                margin-bottom: 2px !important;
                font-size: 8px !important;
            }

            .attachment-list-item .file-icon {
                margin-right: 4px !important;
                font-size: 8px !important;
            }

            .attachment-list-item .file-name {
                font-size: 8px !important;
            }

            .reimbursement-attachments-section {
                margin-bottom: 8px !important;
                padding: 8px !important;
                background-color: white !important;
                border: 1px solid #000 !important;
                page-break-inside: avoid !important;
            }

            .attachments-section h3 {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                padding-bottom: 3px !important;
            }

            .reimbursement-attachments-section h3 {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                padding-bottom: 3px !important;
            }

            .reimbursement-header h4 {
                font-size: 10px !important;
                margin-bottom: 5px !important;
            }

            .reimbursement-attachments-list {
                gap: 2px !important;
            }

            .reimbursement-attachments-list .flex {
                padding: 2px 4px !important;
                font-size: 8px !important;
            }

            .reimbursement-attachments-list .text-sm {
                font-size: 8px !important;
            }

            .reimbursement-attachments-list .text-xs {
                font-size: 7px !important;
            }

            #printOutReimbursementSection {
                margin-bottom: 5px !important;
            }

            #printOutReimbursementSection h4 {
                font-size: 10px !important;
                margin-bottom: 5px !important;
            }

            #printOutReimbursementList {
                padding: 2px !important;
                min-height: 10px !important;
            }
        }

        .rejection-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dc3545;
            background-color: #f8d7da;
            border-radius: 5px;
        }

        .rejection-section h3 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #dc3545;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 5px;
        }

        .rejection-section #rejectionRemarks {
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
            white-space: pre-wrap;
        }

        /* Attachments Table Styles */
        .attachments-table-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: block !important;
        }

        .attachments-table-section h3 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #17a2b8;
            padding-bottom: 5px;
            font-size: 14px;
        }

        .attachments-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 11px;
        }

        .attachments-table th,
        .attachments-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
            font-size: 10px;
        }

        .attachments-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
        }

        .attachments-table td {
            background-color: #fff;
        }

        .attachments-table .file-name {
            font-weight: 500;
            color: #007bff;
        }

        .attachments-table .file-type {
            text-transform: uppercase;
            font-size: 9px;
            color: #6c757d;
        }

        .attachments-table .file-size {
            text-align: right;
            font-family: monospace;
            font-size: 9px;
        }

        @media print {
            .attachments-table-section {
                margin-bottom: 8px !important;
                padding: 8px !important;
                background-color: white !important;
                border: 1px solid #000 !important;
                page-break-inside: avoid !important;
            }

            .attachments-table-section h3 {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                padding-bottom: 3px !important;
            }

            .attachments-table {
                font-size: 8px !important;
                margin-bottom: 5px !important;
            }

            .attachments-table th,
            .attachments-table td {
                padding: 3px !important;
                font-size: 8px !important;
            }
        }

        @media print {

            .document-info,
            .approval-details,
            .attachments-section,
            #fileAttachmentSection,
            .reimbursement-attachments-section,
            .rejection-section {
                background-color: white !important;
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>

<body>
    <div class="no-print">
        <button class="back-button" onclick="goBack()">Back</button>
        <button class="print-button" onclick="handlePrint()">Print</button>
    </div>

    <div class="voucher-container">
        <div class="header">
            <div class="company-info">
                <div class="company-name">PT KANSAI PAINT INDONESIA</div>
                <div class="company-address">
                    Blok DD-7 & DD-6 Kawasan Industri MM2100,<br>
                    Danau Indah, Cikarang Barat Kab. Bekasi Jawa Barat 17847
                </div>
                <div class="payment-to">
                    Payment to: <span id="paymentTo">Rizki Fajar Putra</span>
                </div>
            </div>
            <div class="voucher-details">
                <div id="voucherNoContainer" style="display: block;">Voucher No. <span id="voucherNo">407B/03/25</span>
                </div>
                <div>Submission Date: <span id="submissionDate">09-June-2025</span></div>
            </div>
        </div>

        <div class="voucher-title">PAYMENT VOUCHER</div>

        <table class="payment-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Account</th>
                    <th>Detail Account</th>
                    <th>Debit</th>
                    <th>Credit</th>
                </tr>
            </thead>
            <tbody id="paymentTableBody">
                <!-- Payment rows will be populated by JavaScript -->
            </tbody>
        </table>

        <!-- Additional Document Information -->
        <div class="document-info">
            <h3>Document Information</h3>
            <div class="info-grid">
                <div>
                    <div class="info-item">
                        <strong>Reimburse No:</strong>
                        <span id="reimburseNo">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Requester:</strong>
                        <span id="requesterName">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Document Date:</strong>
                        <span id="documentDate">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Due Date:</strong>
                        <span id="dueDate">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Status:</strong>
                        <span id="documentStatus">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Journal Memo:</strong>
                        <span id="journalMemo">-</span>
                    </div>
                </div>
                <div>
                    <div class="info-item">
                        <strong>Document Currency:</strong>
                        <span id="documentCurrency">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Transfer Date:</strong>
                        <span id="transferDate">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Account Bank Transfer:</strong>
                        <span id="accountBankTransfer">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Total Transfer:</strong>
                        <span id="totalTransfer">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Remarks:</strong>
                        <span id="documentRemarks">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Journal Remarks:</strong>
                        <span id="journalRemarks">-</span>
                    </div>
                </div>
            </div>
        </div>



        <!-- File Attachment Section -->
        <div class="attachments-section" id="fileAttachmentSection" style="display: block;">
            <h3>File Attachment</h3>
            <div id="fileAttachmentList" class="min-h-8">
                <!-- Reimbursement attachments will be populated by JavaScript -->
                <div id="reimbursementAttachmentsList" class="mb-1" style="display: block;">
                    <!-- Reimbursement attachments will be populated by JavaScript -->
                </div>
                <!-- Print Out Reimbursement document will be displayed here -->
                <div id="printOutReimbursementList" class="min-h-4">
                    <!-- Print Receive Reimbursement document will be displayed here -->
                </div>
            </div>
        </div>



        <!-- Rejection Remarks Section -->
        <div class="rejection-section" id="rejectionSection" style="display: none;">
            <h3>Rejection Remarks</h3>
            <div id="rejectionRemarks">
                <!-- Rejection remarks will be populated by JavaScript -->
            </div>
        </div>

        <div class="approval-boxes">
            <div class="approval-box">
                <div class="approval-title">Prepared by :</div>
                <div class="approval-stamp">
                    <span class="approval-stamp-text">Signed</span>
                </div>
                <div style="text-align: center; margin-top: 3px; font-size: 10px;" id="preparedByBox">-</div>
                <div style="text-align: center; margin-top: 2px; font-size: 8px; color: #666;" id="preparedDateBox">-
                </div>
            </div>
            <div class="approval-box">
                <div class="approval-title">Checked by :</div>
                <div class="approval-stamp">
                    <span class="approval-stamp-text">Signed</span>
                </div>
                <div style="text-align: center; margin-top: 3px; font-size: 10px;" id="checkedByBox">-</div>
                <div style="text-align: center; margin-top: 2px; font-size: 8px; color: #666;" id="checkedDateBox">-
                </div>
            </div>
            <div class="approval-box">
                <div class="approval-title">Acknowledged by :</div>
                <div class="approval-stamp">
                    <span class="approval-stamp-text">Signed</span>
                </div>
                <div style="text-align: center; margin-top: 3px; font-size: 10px;" id="acknowledgedByBox">-</div>
                <div style="text-align: center; margin-top: 2px; font-size: 8px; color: #666;" id="acknowledgedDateBox">
                    -</div>
            </div>
            <div class="approval-box">
                <div class="approval-title">Approved by :</div>
                <div class="approval-stamp">
                    <span class="approval-stamp-text">Approved</span>
                </div>
                <div style="text-align: center; margin-top: 3px; font-size: 10px;" id="approvedBy">N. Widya M.</div>
                <div style="text-align: center; margin-top: 2px; font-size: 8px; color: #666;" id="approvedDateBox">-
                </div>
            </div>
        </div>

        <div class="amount-section">
            <div class="amount-row">
                <span class="amount-label">Amount Payment:</span>
                <span class="amount-value" id="amountPayment">IDR 1,492,532.00</span>
            </div>
            <div class="amount-row">
                <span class="amount-label">Amount in Word:</span>
                <span class="amount-value" id="amountInWord">ONE MILLION FOUR HUNDRED NINETY-TWO THOUSAND FIVE HUNDRED
                    THIRTY-TWO RUPIAH</span>
            </div>
        </div>

        <div class="footer-note">
            Generated by Expressiv system
        </div>

        <!-- Page numbering footer -->
        <div class="page-number-footer" id="pageNumberFooter">
            <span class="page-number-text">Pages <span class="current-page">1</span> of <span
                    class="total-pages">1</span></span>
        </div>
    </div>

    <script>
        // Function to go back to the previous page
        function goBack() {
            window.history.back();
        }

        // Function to format currency
        function formatCurrency(number) {
            if (number === null || number === undefined || number === '') {
                return '0';
            }

            const num = parseFloat(number);
            if (isNaN(num)) {
                return '0';
            }

            return num.toLocaleString('id-ID', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Function to get bank account name based on account code
        // Function to get bank account name based on COA
        function getBankAccountName(accountCode) {
            const accountMapping = {
                '1110': 'Cash on hand (Rp)',
                '1210': 'Mizuho Bank (Rp)',
                '1211': 'Mizuho Bank (US$)',
                '1212': 'Mizuho (JPY)',
                '1213': 'MUFG Bank (Rp)',
                '1214': 'MUFG Bank (US$)',
                '1215': 'MUFG Bank (Jpy)',
                '1222': 'CIMB NIAGA (Rp)',
                '1310': 'Saving Account (IDR, Mizuho)',
                '1313': 'Saving Account (IDR, MUFG)',
                '1316': 'Saving Account (IDR, CIMB NIAGA)'
            };

            return accountMapping[accountCode] || 'Current Account (IDR,BTMU-UFJ)';
        }

        // Function to convert number to words
        function numberToWords(num) {
            const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
            const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
            const teens = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];

            if (num === 0) return 'ZERO';

            function convertLessThanOneThousand(n) {
                if (n === 0) return '';

                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                if (n < 100) {
                    return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
                }
                if (n < 1000) {
                    return ones[Math.floor(n / 10 / 10)] + ' HUNDRED' + (n % 100 !== 0 ? ' ' + convertLessThanOneThousand(n % 100) : '');
                }
            }

            function convert(n) {
                if (n === 0) return 'ZERO';

                const billions = Math.floor(n / 1000000000);
                const millions = Math.floor((n % 1000000000) / 1000000);
                const thousands = Math.floor((n % 1000000) / 1000);
                const remainder = n % 1000;

                let result = '';

                if (billions > 0) {
                    result += convertLessThanOneThousand(billions) + ' BILLION';
                }
                if (millions > 0) {
                    result += (result ? ' ' : '') + convertLessThanOneThousand(millions) + ' MILLION';
                }
                if (thousands > 0) {
                    result += (result ? ' ' : '') + convertLessThanOneThousand(thousands) + ' THOUSAND';
                }
                if (remainder > 0) {
                    result += (result ? ' ' : '') + convertLessThanOneThousand(remainder);
                }

                return result;
            }

            return convert(Math.floor(num)) + ' RUPIAH';
        }

        // Function to populate voucher data
        function populateVoucherData(data, docId) {
            console.log('=== START: populateVoucherData ===');
            console.log('Document ID:', docId);
            console.log('Data received:', data);

            // Set basic information
            document.getElementById('paymentTo').textContent = data.cardName || 'Rizki Fajar Putra';

            // Check if data is from Expressiv (has specific Expressiv fields)
            const isFromExpressiv = data.source === 'expressiv' || data.system === 'expressiv' ||
                (data.docNum && data.docNum.includes('EXP')) ||
                (data.counterRef && data.counterRef.includes('EXP'));

            // Show/hide voucher number based on source
            const voucherNoContainer = document.getElementById('voucherNoContainer');
            if (voucherNoContainer) {
                if (isFromExpressiv) {
                    voucherNoContainer.style.display = 'none';
                } else {
                    voucherNoContainer.style.display = 'block';
                    document.getElementById('voucherNo').textContent = data.docNum || '407B/03/25';
                }
            }

            document.getElementById('submissionDate').textContent = data.docDate ? new Date(data.docDate).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '09-June-2025';

            // Populate additional document information
            document.getElementById('reimburseNo').textContent = data.counterRef || '-';
            document.getElementById('requesterName').textContent = data.requesterName || '-';
            document.getElementById('documentDate').textContent = data.docDate ? new Date(data.docDate).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '-';
            document.getElementById('dueDate').textContent = data.docDueDate ? new Date(data.docDueDate).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '-';
            document.getElementById('documentStatus').textContent = data.approval?.approvalStatus || 'Prepared';
            document.getElementById('journalMemo').textContent = data.jrnlMemo || '-';
            document.getElementById('documentCurrency').textContent = data.docCurr || 'IDR';
            document.getElementById('transferDate').textContent = data.trsfrDate ? new Date(data.trsfrDate).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '-';
            document.getElementById('accountBankTransfer').textContent = data.trsfrAcct || '-';

            // Store bank account name for use in payment table
            // Note: trsfrAcctName is not available in API response
            // Using hardcoded value or mapping based on trsfrAcct
            const bankAccountName = getBankAccountName(data.trsfrAcct) || 'Current Account (IDR,BTMU-UFJ)';
            // Calculate total from lines for Total Transfer
            let totalFromLines = 0;
            if (data.lines && data.lines.length > 0) {
                data.lines.forEach(line => {
                    totalFromLines += line.sumApplied || 0;
                });
            }
            document.getElementById('totalTransfer').textContent = `IDR ${formatCurrency(totalFromLines)}`;
            console.log('PrintOPReim - Remarks data:', data.remarks);
            console.log('PrintOPReim - Journal Remarks data:', data.journalRemarks);
            console.log('PrintOPReim - Comments data:', data.comments);
            console.log('PrintOPReim - JrnlMemo data:', data.jrnlMemo);
            document.getElementById('documentRemarks').textContent = data.remarks || data.comments || '-';
            document.getElementById('journalRemarks').textContent = data.journalRemarks || data.jrnlMemo || '-';

            // Populate payment table
            const paymentTableBody = document.getElementById('paymentTableBody');
            paymentTableBody.innerHTML = '';

            let totalDebit = 0;
            let totalCredit = 0;

            if (data.lines && data.lines.length > 0) {
                // For small content, show all items to fit on one page
                // If total amount is small (less than 1 million), show all items
                const totalAmount = data.lines.reduce((sum, line) => sum + (line.sumApplied || 0), 0);
                const isSmallAmount = totalAmount < 1000000; // Less than 1 million
                const maxItemsPerPage = isSmallAmount ? data.lines.length : Math.min(data.lines.length, 2);
                const itemsToShow = data.lines.slice(0, maxItemsPerPage);

                itemsToShow.forEach((line, index) => {
                    const row = document.createElement('tr');
                    const amount = line.sumApplied || 0;

                    row.innerHTML = `
                        <td>${line.descrip || 'Medical for Children, Rheanika - Rizki Fajar Putra'}</td>
                        <td>${line.acctCode || '7245'}</td>
                        <td>${line.acctName || 'Welfare Expense - A'}</td>
                        <td class="amount">IDR ${formatCurrency(amount)}</td>
                        <td class="amount"></td>
                    `;
                    paymentTableBody.appendChild(row);

                    totalDebit += amount;
                });

                // Add note if there are more items and amount is large
                if (data.lines.length > maxItemsPerPage && !isSmallAmount) {
                    const noteRow = document.createElement('tr');
                    noteRow.innerHTML = `
                        <td colspan="5" style="text-align: center; font-style: italic; color: #666; font-size: 8px;">
                            Note: Showing first ${maxItemsPerPage} items. Total items: ${data.lines.length}
                        </td>
                    `;
                    paymentTableBody.appendChild(noteRow);
                }

                totalCredit = totalDebit;

                // Add credit row for bank account (balancing entry)
                const creditRow = document.createElement('tr');
                creditRow.innerHTML = `
                    <td></td>
                    <td>${data.trsfrAcct || '1213'}</td>
                    <td>${bankAccountName}</td>
                    <td class="amount"></td>
                    <td class="amount">IDR ${formatCurrency(totalDebit)}</td>
                `;
                paymentTableBody.appendChild(creditRow);

                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td style="text-align: right;"><strong>Total</strong></td>
                    <td></td>
                    <td></td>
                    <td class="amount"><strong>IDR ${formatCurrency(totalDebit)}</strong></td>
                    <td class="amount"><strong>IDR ${formatCurrency(totalDebit)}</strong></td>
                `;
                paymentTableBody.appendChild(totalRow);
            }





            // Set approval name
            const approvedBy = document.getElementById('approvedBy');
            if (data.approval && data.approval.approvedByName) {
                approvedBy.textContent = data.approval.approvedByName;
            } else if (data.approval && data.approval.approvedBy) {
                approvedBy.textContent = data.approval.approvedBy;
            }



            // Populate approval boxes
            document.getElementById('preparedByBox').textContent = data.approval?.preparedByName || '-';
            document.getElementById('checkedByBox').textContent = data.approval?.checkedByName || '-';
            document.getElementById('acknowledgedByBox').textContent = data.approval?.acknowledgedByName || '-';

            // Populate approval dates
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            document.getElementById('preparedDateBox').textContent = formatDate(data.approval?.preparedDate);
            document.getElementById('checkedDateBox').textContent = formatDate(data.approval?.checkedDate);
            document.getElementById('acknowledgedDateBox').textContent = formatDate(data.approval?.acknowledgedDate);
            document.getElementById('approvedDateBox').textContent = formatDate(data.approval?.approvedDate);

            // Display attachments table (always show) - Enhanced with receiveOPReim.html model
            console.log('Starting to populate attachments table...');
            const attachmentsTableSection = document.getElementById('attachmentsTableSection');
            const attachmentsTableBody = document.getElementById('attachmentsTableBody');

            console.log('Attachments table section:', attachmentsTableSection);
            console.log('Attachments table body:', attachmentsTableBody);

            if (attachmentsTableSection && attachmentsTableBody) {
                attachmentsTableSection.style.display = 'block';
                attachmentsTableBody.innerHTML = '';

                // Check if attachments exist
                console.log('Data attachments:', data.attachments);
                if (data.attachments && data.attachments.length > 0) {
                    console.log('Found attachments:', data.attachments.length);

                    data.attachments.forEach((attachment, index) => {
                        const row = document.createElement('tr');

                        // Format file size (same as receiveOPReim.html)
                        const formatFileSize = (bytes) => {
                            if (!bytes || bytes === 0) return '0 B';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                        };

                        // Get file type from extension (same as receiveOPReim.html)
                        const getFileType = (fileName) => {
                            const ext = fileName.split('.').pop()?.toLowerCase();
                            if (['pdf'].includes(ext)) return 'PDF';
                            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'Image';
                            if (['doc', 'docx'].includes(ext)) return 'Word';
                            if (['xls', 'xlsx'].includes(ext)) return 'Excel';
                            if (['txt'].includes(ext)) return 'Text';
                            return 'Unknown';
                        };

                        // Format upload date (same as receiveOPReim.html)
                        const formatUploadDate = (dateString) => {
                            if (!dateString) return '-';
                            const date = new Date(dateString);
                            return date.toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        };

                        const fileName = attachment.fileName || attachment.name || `Attachment ${index + 1}`;
                        const fileSize = formatFileSize(attachment.fileSize || attachment.size);
                        const fileType = getFileType(fileName);
                        const uploadDate = formatUploadDate(attachment.uploadDate || attachment.createdDate || attachment.date);

                        row.innerHTML = `
                            <td style="text-align: center;">${index + 1}</td>
                            <td class="file-name">${fileName}</td>
                            <td class="file-type">${fileType}</td>
                            <td class="file-size">${fileSize}</td>
                            <td>${uploadDate}</td>
                        `;
                        attachmentsTableBody.appendChild(row);
                    });
                } else {
                    // Show "No attachments" message
                    console.log('No attachments found');
                    const noAttachmentsRow = document.createElement('tr');
                    noAttachmentsRow.innerHTML = `
                        <td colspan="5" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                            No attachments available for this document
                        </td>
                    `;
                    attachmentsTableBody.appendChild(noAttachmentsRow);
                }
            } else {
                console.error('Attachments table elements not found');
            }

            // Display rejection remarks if available
            if (data.approval && data.approval.rejectionRemarks) {
                const rejectionSection = document.getElementById('rejectionSection');
                const rejectionRemarks = document.getElementById('rejectionRemarks');

                if (rejectionSection && rejectionRemarks) {
                    rejectionSection.style.display = 'block';
                    rejectionRemarks.textContent = data.approval.rejectionRemarks;
                }
            }



            // Set amounts
            document.getElementById('amountPayment').textContent = `IDR ${formatCurrency(totalDebit)}`;
            document.getElementById('amountInWord').textContent = numberToWords(totalDebit);

            // Handle attachments like receiveOPReim.html model
            handleAttachmentsForPrint(data, docId);

            // Display Print Out Reimbursement document
            displayPrintOutReimbursementForPrint(data);

            console.log('=== END: populateVoucherData ===');
        }

        // Function to handle page numbering
        function updatePageNumbers() {
            const pageNumberFooter = document.getElementById('pageNumberFooter');
            if (pageNumberFooter) {
                // Show the footer
                pageNumberFooter.style.display = 'block';
            }
        }

        // Function to handle print event
        function handlePrint() {
            // Update page numbers before printing
            updatePageNumbers();

            // Add CSS for page numbering
            const style = document.createElement('style');
            style.textContent = `
                @page {
                    counter-increment: page;
                }
                
                .current-page::after {
                    content: counter(page);
                }
                
                .total-pages::after {
                    content: counter(pages);
                }
            `;
            document.head.appendChild(style);

            // Trigger print
            window.print();
        }

        // Global variables
        let documentId = null;

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function () {
            console.log('=== START: DOMContentLoaded ===');

            // Get data from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            documentId = urlParams.get('docId') || urlParams.get('id');
            console.log('Document ID from URL:', documentId);

            if (documentId) {
                console.log('Loading data from API for document ID:', documentId);
                // Load data from API like receiveOPReim.html
                loadOPReimDetailsForPrint(documentId);
            } else {
                console.log('No document ID found, using default values');
                // Use default values if no docId
                populateVoucherData({}, null);
            }

            // Initialize page numbering
            updatePageNumbers();

            // Debug: Check if attachments table section exists
            const attachmentsTableSection = document.getElementById('attachmentsTableSection');
            console.log('Attachments table section found:', !!attachmentsTableSection);
            if (attachmentsTableSection) {
                attachmentsTableSection.style.display = 'block';
                console.log('Attachments table section displayed');
            }

            console.log('=== END: DOMContentLoaded ===');
        });

        // Load outgoing payment reimbursement details from API (similar to receiveOPReim.html)
        async function loadOPReimDetailsForPrint(id) {
            try {
                console.log('=== START: loadOPReimDetailsForPrint ===');
                console.log('Document ID:', id);

                // Show loading indicator
                Swal.fire({
                    title: 'Loading...',
                    text: 'Fetching document details for print',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Make API request to get document details
                console.log('Making API request to:', `/api/staging-outgoing-payments/headers/${id}`);
                const response = await makeAuthenticatedRequest(`/api/staging-outgoing-payments/headers/${id}`, {
                    method: 'GET'
                });

                console.log('API response status:', response.status);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                // Parse response data
                const data = await response.json();
                console.log('API response data:', data);

                // Load attachments from API if not in main response
                if (!data.attachments || data.attachments.length === 0) {
                    console.log('No attachments in main response, loading from API...');
                    await loadAttachmentsFromAPIForPrint(id, data);
                } else {
                    console.log('Attachments found in main response:', data.attachments);
                }

                // Load reimbursement attachments if expressivNo is available
                if (data.expressivNo) {
                    console.log('ExpressivNo found, loading reimbursement attachments:', data.expressivNo);
                    await loadReimbursementAttachmentsForPrint(data.expressivNo, data);
                } else {
                    console.log('No expressivNo found in data');
                }

                // Populate form with data
                console.log('Populating voucher data...');
                populateVoucherData(data, id);

                // Close loading indicator
                Swal.close();
                console.log('=== END: loadOPReimDetailsForPrint ===');

            } catch (error) {
                console.error('Error loading document for print:', error);

                Swal.fire({
                    title: 'Error',
                    text: `Failed to load document for print: ${error.message}`,
                    icon: 'error'
                });
            }
        }

        // Load attachments from API (similar to receiveOPReim.html)
        async function loadAttachmentsFromAPIForPrint(docId, mainData) {
            try {
                console.log('=== START: loadAttachmentsFromAPIForPrint ===');
                console.log('Document ID:', docId);

                const response = await makeAuthenticatedRequest(`/api/staging-outgoing-payments/attachments/${docId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('Attachments API response status:', response.status);

                if (!response.ok) {
                    console.log('Attachments API failed, handling error...');
                    await handleAttachmentLoadErrorForPrint(response, docId, mainData);
                    return;
                }

                const result = await response.json();
                console.log('Attachments API response data:', result);

                if (result.data?.length > 0) {
                    console.log('Attachments loaded from API:', result.data);
                    // Update main data with attachments
                    mainData.attachments = result.data;
                    // Display attachments
                    displayAttachmentsForPrint(result.data);
                } else {
                    console.log('No attachments found in API response');
                }

                console.log('=== END: loadAttachmentsFromAPIForPrint ===');

            } catch (error) {
                console.error("Error loading attachments for print:", error);
            }
        }

        // Load reimbursement attachments from API
        async function loadReimbursementAttachmentsForPrint(expressivNo, mainData) {
            try {
                console.log('=== START: loadReimbursementAttachmentsForPrint ===');
                console.log('ExpressivNo:', expressivNo);

                const response = await makeAuthenticatedRequest(`/api/reimbursements/${expressivNo}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('Reimbursement API response status:', response.status);

                if (!response.ok) {
                    console.warn(`Failed to load reimbursement data: ${response.status}`);
                    console.log('=== END: loadReimbursementAttachmentsForPrint (failed) ===');
                    return;
                }

                const result = await response.json();
                console.log('Reimbursement API response data:', result);

                if (result.data?.reimbursementAttachments?.length > 0) {
                    console.log('Reimbursement attachments loaded:', result.data.reimbursementAttachments);
                    // Store reimbursement attachments in main data
                    mainData.reimbursementAttachments = result.data.reimbursementAttachments;
                    // Display reimbursement attachments
                    displayReimbursementAttachmentsForPrint(result.data.reimbursementAttachments);
                } else {
                    console.log('No reimbursement attachments found');
                }

                console.log('=== END: loadReimbursementAttachmentsForPrint ===');

            } catch (error) {
                console.error("Error loading reimbursement attachments for print:", error);
                console.log('=== END: loadReimbursementAttachmentsForPrint (error) ===');
            }
        }

        // Handle attachment loading errors for print (similar to receiveOPReim.html)
        async function handleAttachmentLoadErrorForPrint(response, docId, mainData) {
            console.log('=== START: handleAttachmentLoadErrorForPrint ===');
            console.log('Response status:', response.status);
            console.log('Document ID:', docId);

            if (response.status === 404) {
                console.warn(`No attachments found for document ${docId}`);
                console.log('=== END: handleAttachmentLoadErrorForPrint (404) ===');
                return;
            }

            if (response.status === 405) {
                console.warn('GET method not allowed on attachments endpoint for print, trying alternative approach');

                console.log('Making alternative API request to:', `/api/staging-outgoing-payments/headers/${docId}`);
                const mainResponse = await makeAuthenticatedRequest(`/api/staging-outgoing-payments/headers/${docId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('Alternative API response status:', mainResponse.status);

                if (mainResponse.ok) {
                    const mainResult = await mainResponse.json();
                    console.log('Alternative API response data:', mainResult);

                    if (mainResult.attachments?.length > 0) {
                        console.log('Found attachments in main response for print:', mainResult.attachments);
                        mainData.attachments = mainResult.attachments;
                        displayAttachmentsForPrint(mainResult.attachments);
                        console.log('=== END: handleAttachmentLoadErrorForPrint (405 - success) ===');
                        return;
                    }
                }

                console.log('No attachments found for print');
                console.log('=== END: handleAttachmentLoadErrorForPrint (405 - no attachments) ===');
                return;
            }

            console.warn(`Failed to load attachments for print: ${response.status}`);
            console.log('=== END: handleAttachmentLoadErrorForPrint (other error) ===');
        }

        // Handle attachments for print (similar to receiveOPReim.html)
        async function handleAttachmentsForPrint(result, docId) {
            console.log('=== START: handleAttachmentsForPrint ===');
            console.log('Document ID:', docId);
            console.log('result.attachments:', result.attachments);
            console.log('result.attachments length:', result.attachments?.length);

            if (result.attachments?.length > 0) {
                console.log('Attachments found in main response for print:', result.attachments);
                displayAttachmentsForPrint(result.attachments);
            } else {
                console.log('No attachments in main response for print, trying API endpoint');
                await loadAttachmentsFromAPIForPrint(docId, result);
            }

            console.log('=== END: handleAttachmentsForPrint ===');
        }

        // Display attachments for print (similar to receiveOPReim.html)
        function displayAttachmentsForPrint(attachments) {
            const container = document.getElementById('attachmentsList');
            if (!container) {
                console.error('Attachments container not found');
                return;
            }

            console.log('displayAttachmentsForPrint called with:', attachments);
            console.log('Attachments is array:', Array.isArray(attachments));
            console.log('Attachments length:', attachments?.length);

            // Clear the container completely to prevent duplication
            container.innerHTML = '';

            // Enhanced debugging
            if (!attachments) {
                console.log('No attachments provided (null/undefined)');
                container.innerHTML = '<p class="text-gray-500 text-sm">No attachments found</p>';
                return;
            }

            if (!Array.isArray(attachments)) {
                console.log('Attachments is not an array:', typeof attachments);
                container.innerHTML = '<p class="text-gray-500 text-sm">Invalid attachment data</p>';
                return;
            }

            if (attachments.length === 0) {
                console.log('Attachments array is empty');
                container.innerHTML = '<p class="text-gray-500 text-sm">No attachments found</p>';
                return;
            }

            console.log('Displaying', attachments.length, 'attachments:', attachments);

            const attachmentItems = attachments.map((attachment, index) => {
                console.log(`Processing attachment ${index}:`, attachment);

                const fileName = attachment.fileName || attachment.name || `Attachment ${index + 1}`;
                const fileIcon = getFileIconForPrint(fileName);
                const fileType = attachment.fileType || attachment.contentType || getFileTypeFromName(fileName);

                return createAttachmentItemForPrint(attachment, fileName, fileIcon, fileType, null);
            }).join('');

            container.innerHTML = `
                <div class="space-y-1">
                    ${attachmentItems}
                </div>
            `;

            console.log('Successfully displayed attachment items in container');
        }

        // Display reimbursement attachments for print
        function displayReimbursementAttachmentsForPrint(attachments) {
            const container = document.getElementById('reimbursementAttachmentsList');
            const section = document.getElementById('fileAttachmentSection');

            if (!container || !section) {
                console.error('Reimbursement attachments container or section not found');
                return;
            }

            console.log('displayReimbursementAttachmentsForPrint called with:', attachments);

            // Show the section and container
            section.style.display = 'block';
            container.style.display = 'block';

            // Clear the container
            container.innerHTML = '';

            if (!attachments || attachments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No reimbursement attachments found</p>';
                return;
            }

            const attachmentItems = attachments.map((attachment, index) => {
                const fileName = attachment.fileName || `Reimbursement Attachment ${index + 1}`;
                const fileIcon = getFileIconForPrint(fileName);
                const fileType = attachment.fileType || getFileTypeFromName(fileName);
                return createReimbursementAttachmentItemForPrint(attachment, fileName, fileIcon, fileType, attachment.uploadDate);
            }).join('');

            container.innerHTML = `
                <div class="space-y-1">
                    ${attachmentItems}
                </div>
            `;

            console.log('Successfully displayed reimbursement attachment items in container');
        }

        // Creates attachment item HTML for print (simplified - only document name and type)
        function createAttachmentItemForPrint(attachment, fileName, fileIcon, fileType, uploadDate) {
            return `
                <div class="attachment-list-item blue-theme">
                    <span class="file-icon">${fileIcon}</span>
                    <span class="file-name">${fileName}</span>
                </div>
            `;
        }

        // Creates reimbursement attachment item HTML for print
        function createReimbursementAttachmentItemForPrint(attachment, fileName, fileIcon, fileType, uploadDate) {
            return `
                <div class="attachment-list-item green-theme">
                    <span class="file-icon">${fileIcon}</span>
                    <span class="file-name">${fileName}</span>
                </div>
            `;
        }

        // Get file icon for print (same as receiveOPReim.html)
        function getFileIconForPrint(fileName) {
            const ext = fileName.split('.').pop()?.toLowerCase();
            if (['pdf'].includes(ext)) return '📄';
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return '🖼️';
            if (['doc', 'docx'].includes(ext)) return '📝';
            if (['xls', 'xlsx'].includes(ext)) return '📊';
            if (['txt'].includes(ext)) return '📄';
            return '📎';
        }

        // Get file type from file name
        function getFileTypeFromName(fileName) {
            const ext = fileName.split('.').pop()?.toLowerCase();
            if (['pdf'].includes(ext)) return 'PDF Document';
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'Image File';
            if (['doc', 'docx'].includes(ext)) return 'Word Document';
            if (['xls', 'xlsx'].includes(ext)) return 'Excel Document';
            if (['txt'].includes(ext)) return 'Text Document';
            return 'Document';
        }

        // Format upload date for print
        function formatUploadDateForPrint(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }



        // View attachment for print
        async function viewAttachmentForPrint(attachmentOrPath, fileName) {
            try {
                Swal.fire({
                    title: 'Loading...',
                    text: 'Loading attachment, please wait...',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const docId = documentId;
                if (!docId) {
                    throw new Error('Document ID not found');
                }

                // Normalize attachment parameter
                const attachment = normalizeAttachmentForPrint(attachmentOrPath, fileName);
                console.log('Normalized attachment for print:', attachment);

                // Try to open attachment file
                if (attachment.filePath) {
                    await openAttachmentFileForPrint(attachment.filePath);
                    return;
                }

                // Try to fetch and open attachment
                await fetchAndOpenAttachmentForPrint(docId, attachment);

            } catch (error) {
                console.error('Error viewing attachment for print:', error);

                Swal.fire({
                    title: 'Error',
                    text: `Failed to open attachment: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Normalize attachment parameter for print
        function normalizeAttachmentForPrint(attachmentOrPath, fileName) {
            if (typeof attachmentOrPath === 'string') {
                return { filePath: attachmentOrPath, fileName: fileName };
            }
            return attachmentOrPath;
        }

        // Open attachment file for print
        async function openAttachmentFileForPrint(filePath) {
            console.log('Using direct filePath for print:', filePath);

            Swal.close();

            const fileUrl = constructFileUrlForPrint(filePath);
            if (!fileUrl) {
                throw new Error('Failed to construct file URL');
            }

            window.open(fileUrl, '_blank');
            Swal.fire({
                title: 'Success',
                text: 'Attachment opened in new tab',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // Construct file URL for print
        function constructFileUrlForPrint(filePath) {
            if (!filePath) {
                console.error('No file path provided');
                return null;
            }

            // If it's already a full URL, return as is
            if (filePath.startsWith('http://') || filePath.startsWith('https://')) {
                return filePath;
            }

            // If it's a relative path, construct the full URL
            const baseUrl = window.location.origin;
            return `${baseUrl}/api/files/${encodeURIComponent(filePath)}`;
        }

        // Fetch and open attachment for print
        async function fetchAndOpenAttachmentForPrint(docId, attachment) {
            try {
                console.log('Fetching attachment for print:', attachment);

                const response = await makeAuthenticatedRequest(`/api/staging-outgoing-payments/attachments/${docId}/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attachmentId: attachment.id || attachment.attachmentId })
                });

                if (!response.ok) {
                    await handleAttachmentFetchErrorForPrint(response, docId, attachment);
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
                window.URL.revokeObjectURL(url);

                Swal.close();
                Swal.fire({
                    title: 'Success',
                    text: 'Attachment opened in new tab',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('Error fetching attachment for print:', error);
                throw error;
            }
        }

        // Handle attachment fetch error for print
        async function handleAttachmentFetchErrorForPrint(response, docId, attachment) {
            console.warn(`Failed to fetch attachment for print: ${response.status}`);

            if (response.status === 404) {
                throw new Error('Attachment not found');
            }

            if (response.status === 405) {
                console.warn('POST method not allowed, trying alternative approach for print');
                await tryAlternativeAttachmentFetchForPrint(docId, attachment);
                return;
            }

            throw new Error(`Failed to fetch attachment: ${response.status}`);
        }

        // Try alternative attachment fetch for print
        async function tryAlternativeAttachmentFetchForPrint(docId, attachment) {
            try {
                console.log('Trying alternative attachment fetch for print');

                const response = await makeAuthenticatedRequest(`/api/staging-outgoing-payments/attachments/${docId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Alternative fetch failed: ${response.status}`);
                }

                const result = await response.json();
                const targetAttachment = findTargetAttachmentForPrint(result.data || result, attachment);

                if (targetAttachment && targetAttachment.filePath) {
                    await openAttachmentFileForPrint(targetAttachment.filePath);
                } else {
                    throw new Error('Attachment file path not found');
                }

            } catch (error) {
                console.error('Alternative attachment fetch failed for print:', error);
                throw error;
            }
        }

        // Find target attachment for print
        function findTargetAttachmentForPrint(attachments, target) {
            return attachments.find(att =>
                att.id === target.id ||
                att.attachmentId === target.attachmentId ||
                att.fileName === target.fileName
            );
        }

        // View reimbursement attachment for print
        async function viewReimbursementAttachmentForPrint(attachment) {
            try {
                Swal.fire({
                    title: 'Loading...',
                    text: 'Loading reimbursement attachment, please wait...',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Try to open attachment file directly
                if (attachment.filePath) {
                    await openReimbursementAttachmentFileForPrint(attachment.filePath);
                    return;
                }

                // If no filePath, try to construct URL from filePath
                if (attachment.filePath) {
                    const fileUrl = constructReimbursementFileUrlForPrint(attachment.filePath);
                    if (fileUrl) {
                        window.open(fileUrl, '_blank');
                        Swal.close();
                        Swal.fire({
                            title: 'Success',
                            text: 'Reimbursement attachment opened in new tab',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        return;
                    }
                }

                throw new Error('No file path available for reimbursement attachment');

            } catch (error) {
                console.error('Error viewing reimbursement attachment for print:', error);

                Swal.fire({
                    title: 'Error',
                    text: `Failed to open reimbursement attachment: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Open reimbursement attachment file for print
        async function openReimbursementAttachmentFileForPrint(filePath) {
            console.log('Using direct filePath for reimbursement attachment:', filePath);

            Swal.close();

            const fileUrl = constructReimbursementFileUrlForPrint(filePath);
            if (!fileUrl) {
                throw new Error('Failed to construct reimbursement file URL');
            }

            window.open(fileUrl, '_blank');
            Swal.fire({
                title: 'Success',
                text: 'Reimbursement attachment opened in new tab',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // Construct reimbursement file URL for print
        function constructReimbursementFileUrlForPrint(filePath) {
            if (!filePath) {
                console.error('No file path provided for reimbursement attachment');
                return null;
            }

            // If it's already a full URL, return as is
            if (filePath.startsWith('http://') || filePath.startsWith('https://')) {
                return filePath;
            }

            // If it's a relative path, construct the full URL
            const baseUrl = window.location.origin;
            return `${baseUrl}/api/files/${encodeURIComponent(filePath)}`;
        }

        // Function to display Print Out Reimbursement document for print
        function displayPrintOutReimbursementForPrint(reimbursementData) {
            const container = document.getElementById('printOutReimbursementList');
            const fileAttachmentSection = document.getElementById('fileAttachmentSection');

            if (!container) {
                console.warn('Print Out Reimbursement container not found: printOutReimbursementList');
                return;
            }

            // Show the file attachment section
            if (fileAttachmentSection) {
                fileAttachmentSection.style.display = 'block';
            }

            // Clear existing content
            container.innerHTML = '';

            // Get reimbursement ID from various possible sources
            let reimbursementId = null;

            // Try to get from URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            reimbursementId = urlParams.get('reimbursement-id') || urlParams.get('id') || documentId;

            // If not in URL, try to get from form data
            if (!reimbursementId) {
                const counterRefField = document.getElementById('CounterRef');
                if (counterRefField && counterRefField.value) {
                    reimbursementId = counterRefField.value;
                }
            }

            // If still not found, try to get from reimbursement data
            if (!reimbursementId && reimbursementData && reimbursementData.id) {
                reimbursementId = reimbursementData.id;
            }

            if (!reimbursementId) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Reimbursement ID not found</p>';
                return;
            }

            // Build the Print Receive Reimbursement URL with parameters
            const baseUrl = window.location.origin;
            const printReimUrl = `${baseUrl}/approvalPages/approval/receive/reimbursement/printReim.html?reim-id=${reimbursementId}`;

            // Add additional parameters if available from reimbursement data
            let fullUrl = printReimUrl;
            if (reimbursementData) {
                const params = new URLSearchParams();

                // Add all available parameters from reimbursement data
                if (reimbursementData.cardName) params.append('payTo', encodeURIComponent(reimbursementData.cardName));
                if (reimbursementData.counterRef) params.append('voucherNo', encodeURIComponent(reimbursementData.counterRef));
                if (reimbursementData.docDate) params.append('submissionDate', reimbursementData.docDate);
                if (reimbursementData.requesterName) params.append('preparedBy', encodeURIComponent(reimbursementData.requesterName));
                if (reimbursementData.totalAmountDue) params.append('totalAmount', reimbursementData.totalAmountDue);
                if (reimbursementData.docCurr) params.append('currency', reimbursementData.docCurr);
                if (reimbursementData.comments) params.append('remarks', encodeURIComponent(reimbursementData.comments));

                // Add details if available
                if (reimbursementData.lines && reimbursementData.lines.length > 0) {
                    const details = reimbursementData.lines.map(line => ({
                        category: line.category || '',
                        accountName: line.acctName || '',
                        glAccount: line.acctCode || '',
                        description: line.descrip || '',
                        amount: line.sumApplied || 0
                    }));
                    params.append('details', encodeURIComponent(JSON.stringify(details)));
                }

                // If we have parameters, append them to the URL
                if (params.toString()) {
                    fullUrl += '&' + params.toString();
                }
            }

            // Create the document item
            const documentItem = document.createElement('div');
            documentItem.className = 'attachment-list-item blue-theme';

            // Use a document icon for the print reimbursement
            documentItem.innerHTML = `
                <span class="file-icon">📄</span>
                <span class="file-name">Print Receive Reimbursement.pdf</span>
            `;

            container.appendChild(documentItem);
        }

        // Function to view Print Reimbursement document for print
        async function viewPrintReimbursementForPrint(url) {
            try {
                // Show loading indicator
                Swal.fire({
                    title: 'Loading...',
                    text: 'Loading Print Receive Reimbursement document...',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Open the URL in a new window/tab
                const newWindow = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

                if (newWindow) {
                    // Close loading indicator
                    Swal.close();

                    // Show success message
                    Swal.fire({
                        title: 'Success',
                        text: 'Print Receive Reimbursement document opened in new window',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    throw new Error('Failed to open document window');
                }

            } catch (error) {
                console.error('Error viewing Print Reimbursement document:', error);

                Swal.fire({
                    title: 'Error',
                    text: `Failed to open Print Receive Reimbursement document: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Function to open Print Reimbursement document in new tab for print
        function openPrintReimbursementForPrint(url) {
            try {
                window.open(url, '_blank');
            } catch (error) {
                console.error('Error opening Print Reimbursement document:', error);

                Swal.fire({
                    title: 'Error',
                    text: `Failed to open Print Receive Reimbursement document: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    </script>
</body>